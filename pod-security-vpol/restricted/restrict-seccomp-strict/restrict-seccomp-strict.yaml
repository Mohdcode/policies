apiVersion: policies.kyverno.io/v1alpha1
kind: ValidatingPolicy
metadata:
  name: restrict-seccomp-strict
  annotations:
    policies.kyverno.io/title: Restrict Seccomp (Strict) in ValidatingPolicy
    policies.kyverno.io/category: Pod Security Standards (Restricted) in ValidatingPolicy
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.14.0
    kyverno.io/kyverno-version: 1.14.0
    kyverno.io/kubernetes-version: "1.30+"
    policies.kyverno.io/description: >-
      The seccomp profile in the Restricted group must not be explicitly set to Unconfined
      but additionally must also not allow an unset value. This policy, 
      requiring Kubernetes v1.30 or later, ensures that seccomp is 
      set to `RuntimeDefault` or `Localhost`. A known issue prevents a policy such as this
      using `anyPattern` from being persisted properly in Kubernetes 1.23.0-1.23.2.
spec:
  validationActions:
     - Audit
  evaluation:
    background:
      enabled: true
  matchConstraints:
    resourceRules:
      - apiGroups:   [""]
        apiVersions: ["v1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["pods"]
  variables:
  - name: allContainers
    expression: >-
      object.spec.containers + 
      (has(object.spec.initContainers) ? object.spec.initContainers : []) + 
      (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers : [])

  validations:
  - expression: >- 
      (!has(object.spec.securityContext) || 
       !has(object.spec.securityContext.seccompProfile) || 
       !has(object.spec.securityContext.seccompProfile.type) || 
       object.spec.securityContext.seccompProfile.type.orValue('RuntimeDefault') in ['RuntimeDefault', 'Localhost']) &&
      variables.allContainers.all(container, 
        !has(container.securityContext) || 
        !has(container.securityContext.seccompProfile) || 
        !has(container.securityContext.seccompProfile.type) || 
        container.securityContext.seccompProfile.type.orValue('RuntimeDefault') in ['RuntimeDefault', 'Localhost'])
    message: >-
      Use of custom Seccomp profiles is disallowed. The field securityContext.seccompProfile.type 
      must be set to `RuntimeDefault` or `Localhost`.
