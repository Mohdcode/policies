apiVersion: policies.kyverno.io/v1beta1
kind: ValidatingPolicy
metadata:
  name: require-pod-probes
  annotations:
    policies.kyverno.io/title: Require Pod Probes in ValidatingPolicy
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Liveness and readiness probes are essential for managing Pod lifecycle during
      deployments, restarts, and upgrades. Liveness probes help the kubelet determine
      when to restart containers, while readiness probes help Services and Deployments
      determine when Pods are ready to receive traffic. Startup probes provide additional
      control during container startup. This policy validates that all containers have
      at least one of livenessProbe, readinessProbe, or startupProbe defined.      
    policies.kyverno.io/minversion: "1.14.0"
spec:
  validationActions: ["Deny"]
  autogen:
    podControllers:
      controllers: ["Deployment", "StatefulSet", "DaemonSet", "Job", "CronJob", "ReplicaSet", "ReplicationController"]
  matchConstraints:
    resourceRules:
    - apiGroups: [""]
      apiVersions: ["v1"]
      resources: ["pods"]
      operations: ["CREATE", "UPDATE"]
    - apiGroups: ["apps"]
      apiVersions: ["v1"]
      resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
      operations: ["CREATE", "UPDATE"]
    - apiGroups: ["batch"]
      apiVersions: ["v1", "v1beta1"]
      resources: ["jobs", "cronjobs"]
      operations: ["CREATE", "UPDATE"]
  variables:
  - name: allContainers
    expression: >-
      has(object.spec.containers) ? 
        object.spec.containers + object.spec.?initContainers.orValue([]) + object.spec.?ephemeralContainers.orValue([]) : 
        object.spec.template.spec.containers + object.spec.template.spec.?initContainers.orValue([]) + object.spec.template.spec.?ephemeralContainers.orValue([])      
  validations:
  - expression: >-
      variables.allContainers.all(container, 
        has(container.livenessProbe) || has(container.readinessProbe) || has(container.startupProbe)
      )      
    messageExpression: >-
      'All containers must have at least one probe (livenessProbe, readinessProbe, or startupProbe) defined. Missing probes in containers: ' + 
      variables.allContainers.filter(container, 
        !(has(container.livenessProbe) || has(container.readinessProbe) || has(container.startupProbe))
      ).map(container, container.name).join(', ')  